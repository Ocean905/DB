<div class="container">
  <div class="sidebar">
    <button [class.active]="selectedTable === 'invoice_transactions'" 
            (click)="selectTable('invoice_transactions')">
      品項管理
    </button>
    <button [class.active]="selectedTable === 'invoice_transtions_categories'"
            (click)="selectTable('invoice_transtions_categories')">
      類別管理
    </button>
    <button [class.active]="selectedTable === 'HSR'"
            (click)="selectTable('HSR')">
      高鐵站別
    </button>
  </div>

  <div class="main-content">
    <div *ngIf="loading" class="loading">載入中...</div>
    <div *ngIf="error" class="error">{{error}}</div>
    <div class="header">
      <h2>{{getTableTitle()}}</h2>
      <button class="add-button" (click)="openAddModal()">新增</button>
    </div>

    <!-- 品項表格 -->
    <table *ngIf="selectedTable === 'invoice_transactions'">
      <thead>
        <tr>
          <th>名稱</th>
          <th>單位</th>
          <th>係數</th>
          <th>類別</th>
          <th>資料來源</th>
          <th>資料來源組織</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let item of transactions">
          <td>{{item.name}}</td>
          <td>{{item.unit}}</td>
          <td>{{item.coefficient}}</td>
          <td>{{item.category}}</td>
          <td class="source-column">{{item.source}}</td>
          <td class="source-column">{{item.source_name}}</td>
          <td>
            <button class="edit-btn" (click)="openEditModal(item)">編輯</button>
            <button class="delete-btn" (click)="deleteItem(item._id)">刪除</button>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- 類別表格 -->
    <table *ngIf="selectedTable === 'invoice_transtions_categories'">
      <thead>
        <tr>
          <th>名稱</th>
          <th>父類別</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let item of categories">
          <td>{{item.name}}</td>
          <td>{{item.parent}}</td>
          <td>
            <button class="edit-btn" (click)="openEditModal(item)">編輯</button>
            <button class="delete-btn" (click)="deleteItem(item._id)">刪除</button>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- 高鐵站別表格 -->
    <table *ngIf="selectedTable === 'HSR'">
      <thead>
        <tr>
          <th>起始站</th>
          <th>終點站</th>
          <th>碳足跡</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let item of hsrStations">
          <td>{{item.origin}}</td>
          <td>{{item.destination}}</td>
          <td>{{item.carbonFootprint}}</td>
          <td>
            <button class="edit-btn" (click)="openEditModal(item)">編輯</button>
            <button class="delete-btn" (click)="deleteItem(item._id)">刪除</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- 刪除確認框 -->
<div class="delete-modal" *ngIf="showDeleteConfirm">
  <div class="delete-modal-content">
    <div class="delete-modal-header">
      <h3>確認刪除</h3>
    </div>
    <div class="delete-modal-body">
      <p>確定要刪除此項目嗎？此操作無法復原。</p>
    </div>
    <div class="delete-modal-footer">
      <button class="btn-cancel" (click)="cancelDelete()">取消</button>
      <button class="btn-delete" (click)="confirmDelete()">確認刪除</button>
    </div>
  </div>
</div>

<!-- 編輯/新增模態框 -->
<div class="modal" *ngIf="showModal">
  <div class="modal-content">
    <h2>{{getModalTitle()}}</h2>
    <form #itemForm="ngForm" (ngSubmit)="saveItem()">
      <!-- 品項表單 -->
      <div *ngIf="selectedTable === 'invoice_transactions'">
        <div class="form-group">
          <label>名稱 <span class="required">*</span></label>
          <input type="text" [(ngModel)]="editingTransaction!.name" name="name" required>
        </div>
        <div class="form-group">
          <label>單位 <span class="required">*</span></label>
          <input type="text" [(ngModel)]="editingTransaction!.unit" name="unit" required>
        </div>
        <div class="form-group">
          <label>係數 <span class="required">*</span></label>
          <input type="number" [(ngModel)]="editingTransaction!.coefficient" name="coefficient" required>
        </div>
        <div class="form-group">
          <label>類別 <span class="required">*</span></label>
          <div class="search-select">
            <input type="text" 
                   [(ngModel)]="categorySearch" 
                   (input)="searchCategories()"
                   name="categorySearch"
                   placeholder="搜尋類別..."
                   [value]="editingTransaction!.category">
            <div class="search-results" *ngIf="filteredCategories.length > 0">
              <div *ngFor="let category of filteredCategories"
                   (click)="selectCategory(category)"
                   class="search-item">
                {{category.name}}
              </div>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label>資料來源</label>
          <input type="text" [(ngModel)]="editingTransaction!.source" name="source">
        </div>
        <div class="form-group">
          <label>資料來源組織</label>
          <input type="text" [(ngModel)]="editingTransaction!.source_name" name="source_name">
        </div>
      </div>


      <!-- 類別表單 -->
      <div *ngIf="selectedTable === 'invoice_transtions_categories'">
        <div class="form-group">
          <label>名稱 <span class="required">*</span></label>
          <input type="text" [(ngModel)]="editingCategory!.name" name="name" required>
        </div>
        <div class="form-group">
          <label>父類別 <span class="required">*</span></label>
          <input type="text" [(ngModel)]="editingCategory!.parent" name="parent" required>
        </div>
      </div>

      <!-- 高鐵站別表單 -->
      <div *ngIf="selectedTable === 'HSR'">
        <div class="form-group">
          <label>起始站 <span class="required">*</span></label>
          <input type="text" [(ngModel)]="editingHSR!.origin" name="origin" required>
        </div>
        <div class="form-group">
          <label>終點站 <span class="required">*</span></label>
          <input type="text" [(ngModel)]="editingHSR!.destination" name="destination" required>
        </div>
        <div class="form-group">
          <label>碳足跡 <span class="required">*</span></label>
          <input type="number" [(ngModel)]="editingHSR!.carbonFootprint" name="carbonFootprint" required>
        </div>
      </div>

      <div class="button-group">
        <button type="button" (click)="closeModal()">取消</button>
        <button type="submit" [disabled]="!itemForm.form.valid">儲存</button>
      </div>
    </form>
  </div>
</div>
<!-- 錯誤提示彈窗 (移到這裡) -->
<div class="error-modal" *ngIf="showErrorMessage">
  <div class="error-modal-content">
    <div class="error-modal-header">
      <h3>提示</h3>
    </div>
    <div class="error-modal-body">
      <p>{{errorMessage}}</p>
    </div>
    <div class="error-modal-footer">
      <button class="btn-confirm" (click)="closeErrorModal()">確定</button>
    </div>
  </div>